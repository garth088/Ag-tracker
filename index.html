<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>AG Tracker</title>
  <meta name="description" content="Simple, private habit & activity tracker with daily streaks." />
<link rel="manifest" href="./manifest.webmanifest" />
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<meta name="theme-color" content="#0b1220" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg: #0b1220;
      --card:#121a2b;
      --muted:#8aa0b8;
      --text:#e7eef8;
      --brand:#6dd3ff;
      --accent:#61ffa8;
      --danger:#ff7a7a;
      --ring:#2b3c5c;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --gutter: 14px;
      --tap: 52px;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f8fafc; --card:#ffffff; --muted:#6b7280; --text:#0f172a; --ring:#dbe3f0; --shadow:0 8px 24px rgba(2,6,23,.08) }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text); background:linear-gradient(180deg, var(--bg), #0e1628 60%, var(--bg));
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .app{
      max-width: 520px;
      margin: 0 auto;
      min-height: 100%;
      display:flex; flex-direction:column;
    }
    header{
      position:sticky; top:0; z-index:5;
      background:rgba(11,18,32,.7); backdrop-filter:saturate(180%) blur(14px);
      border-bottom:1px solid var(--ring);
    }
    .h-wrap{display:flex; align-items:center; gap:10px; padding:14px var(--gutter)}
    .logo{
      width:34px; height:34px; border-radius:10px; display:grid; place-items:center;
      background: radial-gradient(120% 120% at 20% 20%, var(--brand), #8ef, #4fb6ff 70%);
      color:#07263a; font-weight:900; box-shadow: var(--shadow);
    }
    .title{ font-size:18px; font-weight:800; letter-spacing:.2px }
    .subtitle{ font-size:12px; color:var(--muted) }

    main{ flex:1; padding: var(--gutter); padding-bottom: calc(var(--tap) + 28px) }
    .grid{ display:grid; gap: var(--gutter) }
    .card{
      background:var(--card); border:1px solid var(--ring); border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .card-h{ padding:12px 14px; border-bottom:1px solid var(--ring); font-weight:700; display:flex; align-items:center; justify-content:space-between }
    .card-c{ padding:12px 14px }

    .row{ display:flex; align-items:center; gap:10px }
    .grow{ flex:1 }

    /* Progress Bar */
    .bar{ height:12px; background:#0f1a2e; border-radius:999px; border:1px solid var(--ring); overflow:hidden }
    .bar > span{ display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent),#b5ffdd); transition:width .35s ease }

    /* Habit item */
    .habit{ display:flex; align-items:center; gap:12px; padding:10px; border-radius:12px; border:1px solid var(--ring); background:rgba(255,255,255,.02) }
    .habit + .habit{ margin-top:10px }
    .chk{
      width:28px; height:28px; border-radius:9px; border:2px solid var(--brand); display:grid; place-items:center;
      background:transparent; color:var(--brand);
    }
    .chk.done{ background:var(--brand); color:#062235; border-color:transparent }
    .habit-title{ font-weight:700 }
    .habit-note{ font-size:12px; color:var(--muted) }

    /* Buttons & inputs */
    button, .btn{
      appearance:none; border:none; background:var(--brand); color:#062235;
      padding:12px 14px; border-radius:14px; font-weight:800; box-shadow: var(--shadow);
    }
    button.ghost{ background:transparent; color:var(--text); border:1px solid var(--ring) }
    button.danger{ background:var(--danger); color:#3a0707 }
    input[type="text"], input[type="number"]{
      width:100%; padding:12px 12px; border-radius:12px; border:1px solid var(--ring);
      background:transparent; color:var(--text)
    }
    label{ font-size:12px; color:var(--muted) }

    /* Bottom Nav */
    .tabs{
      position:sticky; bottom:0; z-index:5; background:rgba(11,18,32,.75);
      backdrop-filter:saturate(180%) blur(14px); border-top:1px solid var(--ring)
    }
    .tabs ul{ display:flex; margin:0; padding:6px; list-style:none; gap:8px }
    .tabs button{
      flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:6px; padding:10px 6px; border-radius:14px; background:transparent; color:var(--muted); border:1px solid transparent
    }
    .tabs button.active{ color:var(--text); border-color:var(--ring); background:rgba(255,255,255,.02) }
    .caps{ font-size:10px; letter-spacing:.6px; text-transform:uppercase }

    /* Chips */
    .chip{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--ring); color:var(--muted) }
    .chip.good{ color:#0a3; border-color:#0a3 }

    canvas{ width:100%; height:160px; display:block }

    /* Large tap targets for mobile */
    .tap{ min-height: var(--tap); display:flex; align-items:center; justify-content:center }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="h-wrap">
        <div class="logo" aria-hidden="true">AG</div>
        <div>
          <div class="title">AG Tracker</div>
          <div class="subtitle" id="todayLabel">Today</div>
        </div>
        <div class="grow"></div>
        <button class="ghost tap" id="shareBtn" title="Export data">Export</button>
      </div>
    </header>

    <main>
      <!-- TODAY -->
      <section class="view" id="view-today" role="region" aria-labelledby="tab-today">
        <div class="grid">
          <div class="card">
            <div class="card-h">Daily Progress <span class="chip" id="streakChip" title="Current streak">0-day streak</span></div>
            <div class="card-c">
              <div class="row" style="gap:12px">
                <div class="grow">
                  <div class="bar" aria-label="Daily completion">
                    <span id="progressFill" style="width:0%"></span>
                  </div>
                </div>
                <div id="progressPct" style="min-width:48px; text-align:right; font-weight:800">0%</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-h">Your Habits
              <button class="ghost" id="addHabitBtn" aria-label="Add habit">+ Add</button>
            </div>
            <div class="card-c" id="habitList" aria-live="polite"></div>
            <div class="card-c" style="border-top:1px solid var(--ring)">
              <div class="row" style="gap:8px">
                <button id="completeAllBtn" class="btn grow">Mark All Done</button>
                <button id="resetTodayBtn" class="ghost grow">Reset Today</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-h">Quick Add</div>
            <div class="card-c">
              <form id="quickForm" class="grid" style="grid-template-columns:1fr auto; gap:10px">
                <input required type="text" id="qTitle" placeholder="Name a habit (e.g., Short walk)" />
                <button type="submit">Add</button>
              </form>
              <div style="margin-top:10px; font-size:12px; color:var(--muted)">Habits are private and stored only on your device.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- PROGRESS -->
      <section class="view" id="view-progress" hidden role="region" aria-labelledby="tab-progress">
        <div class="grid">
          <div class="card">
            <div class="card-h">Last 30 Days</div>
            <div class="card-c">
              <canvas id="trendChart" height="180" aria-label="Trend chart (completion by day)"></canvas>
              <div class="row" style="margin-top:10px">
                <span class="chip">Best: <span id="bestDay">0%</span></span>
                <span class="chip">Avg: <span id="avgDay">0%</span></span>
                <span class="chip good">Current Streak: <span id="streakDay">0</span>d</span>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-h">History</div>
            <div class="card-c" id="historyGrid">
              <!-- Filled by JS: mini heatmap-like list -->
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section class="view" id="view-settings" hidden role="region" aria-labelledby="tab-settings">
        <div class="grid">
          <div class="card">
            <div class="card-h">Data</div>
            <div class="card-c grid" style="gap:10px">
              <button id="exportBtn">Export (JSON)</button>
              <label for="importFile">Import (JSON)</label>
              <input type="file" id="importFile" accept="application/json" />
              <button class="danger" id="wipeBtn">Erase All Data</button>
            </div>
          </div>
          <div class="card">
            <div class="card-h">About</div>
            <div class="card-c">
              <p><strong>AG Tracker</strong> keeps your habits local (no accounts, no cloud). Add habits, check them off daily, and watch your streak grow.</p>
              <p class="subtitle">Tip: Add 2–5 small, repeatable items. Consistency beats intensity.</p>
            </div>
          </div>
        </div>
      </section>
    </main>

    <nav class="tabs" role="tablist" aria-label="Primary">
      <ul>
        <li class="grow"><button id="tab-today" class="active" role="tab" aria-controls="view-today" aria-selected="true">
          <span aria-hidden="true">🏠</span><span class="caps">Today</span>
        </button></li>
        <li class="grow"><button id="tab-progress" role="tab" aria-controls="view-progress" aria-selected="false">
          <span aria-hidden="true">📈</span><span class="caps">Progress</span>
        </button></li>
        <li class="grow"><button id="tab-settings" role="tab" aria-controls="view-settings" aria-selected="false">
          <span aria-hidden="true">⚙️</span><span class="caps">Settings</span>
        </button></li>
      </ul>
    </nav>
  </div>

  <template id="habitItemTpl">
    <div class="habit">
      <button class="chk" aria-pressed="false" title="Toggle complete"><span class="sr-only">Toggle</span>✓</button>
      <div class="grow">
        <div class="habit-title"></div>
        <div class="habit-note"></div>
      </div>
      <button class="ghost editBtn">Edit</button>
      <button class="ghost danger delBtn" title="Delete">Del</button>
    </div>
  </template>

  <dialog id="habitDialog">
    <form method="dialog" id="habitForm" class="card" style="padding:0; border:none">
      <div class="card-h">Habit</div>
      <div class="card-c grid" style="gap:10px">
        <div>
          <label for="hTitle">Title</label>
          <input id="hTitle" type="text" required placeholder="e.g., 5-minute stretch" />
        </div>
        <div>
          <label for="hNote">Note (optional)</label>
          <input id="hNote" type="text" placeholder="when/where, etc." />
        </div>
      </div>
      <div class="card-c" style="border-top:1px solid var(--ring)">
        <div class="row" style="gap:8px">
          <button class="ghost grow" value="cancel">Cancel</button>
          <button class="grow" id="saveHabitBtn" value="default">Save</button>
        </div>
      </div>
    </form>
  </dialog>

  <script>
    ;(() => {
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));

      const stateKey = 'agtracker_v1';
      const todayISO = () => new Date().toISOString().slice(0,10);
      const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

      /** State shape
       * {
       *  habits: [{id, title, note, created}], // static list
       *  days: { 'YYYY-MM-DD': { done: Set([habitId,...]) } },
       *  createdAt, updatedAt
       * }
       */
      const defaultState = () => ({
        habits: [
          { id: crypto.randomUUID(), title: 'Short walk', note: '2–5 minutes near door', created: Date.now() },
          { id: crypto.randomUUID(), title: 'Deep breaths', note: '3 x 10 breaths', created: Date.now() },
          { id: crypto.randomUUID(), title: 'Tidy one thing', note: '60 seconds', created: Date.now() }
        ],
        days: {},
        createdAt: Date.now(),
        updatedAt: Date.now()
      });

      let state = load();

      function load(){
        try{
          const raw = localStorage.getItem(stateKey);
          if(!raw) return defaultState();
          const obj = JSON.parse(raw);
          // revive Sets
          Object.keys(obj.days || {}).forEach(k=>{
            if(obj.days[k] && Array.isArray(obj.days[k].done)) obj.days[k].done = new Set(obj.days[k].done);
          });
          return obj;
        }catch(e){ console.warn('Failed to load state', e); return defaultState(); }
      }
      function save(){
        const obj = structuredClone(state);
        // serialize Sets
        const days = {};
        Object.keys(obj.days).forEach(k=>{
          days[k] = { done: Array.from(obj.days[k].done || []) };
        });
        obj.days = days;
        obj.updatedAt = Date.now();
        localStorage.setItem(stateKey, JSON.stringify(obj));
        render();
      }

      // Tabs
      const views = {
        today: $('#view-today'),
        progress: $('#view-progress'),
        settings: $('#view-settings')
      };
      function switchTo(tab){
        for(const [k, el] of Object.entries(views)){
          const active = k === tab;
          el.hidden = !active;
          const btn = $('#tab-' + k);
          btn.classList.toggle('active', active);
          btn.setAttribute('aria-selected', active ? 'true' : 'false');
        }
      }
      $('#tab-today').addEventListener('click', ()=>switchTo('today'));
      $('#tab-progress').addEventListener('click', ()=>{ switchTo('progress'); drawTrend(); });
      $('#tab-settings').addEventListener('click', ()=>switchTo('settings'));

      // Header date
      function prettyToday(){
        const d = new Date();
        return d.toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric' });
      }
      $('#todayLabel').textContent = prettyToday();

      // Habits UI
      const listEl = $('#habitList');
      const tpl = $('#habitItemTpl');

      function ensureDay(date = todayISO()){
        if(!state.days[date]) state.days[date] = { done: new Set() };
        if(!(state.days[date].done instanceof Set)) state.days[date].done = new Set(state.days[date].done || []);
      }
      function toggleHabit(id, date = todayISO()){
        ensureDay(date);
        const set = state.days[date].done;
        if(set.has(id)) set.delete(id); else set.add(id);
        save();
      }
      function completeAll(date = todayISO()){
        ensureDay(date);
        const set = state.days[date].done;
        set.clear();
        state.habits.forEach(h=> set.add(h.id));
        save();
      }
      function resetToday(date = todayISO()){
        if(state.days[date]){ state.days[date].done = new Set(); save(); }
      }

      function editHabit(habit){
        const dialog = $('#habitDialog');
        const title = $('#hTitle');
        const note = $('#hNote');
        title.value = habit?.title ?? '';
        note.value = habit?.note ?? '';
        dialog.showModal();
        dialog.returnValue = '';
        $('#saveHabitBtn').onclick = (e) => {
          e.preventDefault();
          const t = title.value.trim();
          if(!t) return;
          if(habit){
            habit.title = t;
            habit.note = note.value.trim();
          }else{
            state.habits.push({ id: crypto.randomUUID(), title: t, note: note.value.trim(), created: Date.now() });
          }
          dialog.close('saved');
          save();
        };
      }

      $('#addHabitBtn').addEventListener('click', ()=>editHabit(null));
      $('#quickForm').addEventListener('submit', e=>{
        e.preventDefault();
        const t = $('#qTitle').value.trim();
        if(!t) return;
        state.habits.push({ id: crypto.randomUUID(), title:t, note:'', created: Date.now() });
        $('#qTitle').value='';
        save();
      });
      $('#completeAllBtn').addEventListener('click', ()=>completeAll());
      $('#resetTodayBtn').addEventListener('click', ()=>resetToday());

      function renderHabits(){
        listEl.innerHTML = '';
        ensureDay();
        const done = state.days[todayISO()].done;
        if(state.habits.length === 0){
          const empty = document.createElement('div');
          empty.className = 'subtitle';
          empty.textContent = 'No habits yet — add one above.';
          listEl.appendChild(empty);
          return;
        }
        for(const h of state.habits){
          const node = tpl.content.firstElementChild.cloneNode(true);
          const chk = node.querySelector('.chk');
          const t = node.querySelector('.habit-title');
          const n = node.querySelector('.habit-note');
          t.textContent = h.title;
          n.textContent = h.note || '—';
          const isDone = done.has(h.id);
          chk.classList.toggle('done', isDone);
          chk.setAttribute('aria-pressed', isDone ? 'true' : 'false');
          chk.addEventListener('click', ()=>toggleHabit(h.id));

          node.querySelector('.editBtn').addEventListener('click', ()=>editHabit(h));
          node.querySelector('.delBtn').addEventListener('click', ()=>{
            if(confirm('Delete this habit?')){
              // Remove from list
              state.habits = state.habits.filter(x=>x.id!==h.id);
              // Remove from all day sets
              Object.values(state.days).forEach(d=> d.done?.delete(h.id));
              save();
            }
          });

          listEl.appendChild(node);
        }
      }

      // Progress
      function todayPct(){
        ensureDay();
        const total = state.habits.length || 1;
        const done = state.days[todayISO()].done.size;
        return Math.round((done/total) * 100);
      }
      function updateProgressBar(){
        const pct = todayPct();
        $('#progressFill').style.width = pct + '%';
        $('#progressPct').textContent = pct + '%';
      }

      // Streaks & history
      function dateAdd(baseISO, days){
        const d = new Date(baseISO); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10);
      }
      function prevDay(iso){ return dateAdd(iso, -1) }
      function dayComplete(iso){
        const d = state.days[iso];
        if(!d) return false;
        const total = state.habits.length || 1;
        return (d.done?.size || 0) >= Math.min(total, Math.max(1, total)); // all habits
      }
      function calcStreak(){
        let streak = 0;
        let cur = todayISO();
        while(dayComplete(cur)){
          streak++; cur = prevDay(cur);
        }
        return streak;
      }
      function renderStreak(){
        const s = calcStreak();
        $('#streakChip').textContent = s + (s===1?'-day streak':'-day streak');
        $('#streakDay').textContent = s;
      }

      // History grid (mini heatmap)
      function renderHistory(){
        const el = $('#historyGrid');
        el.innerHTML = '';
        const wrap = document.createElement('div');
        wrap.style.display = 'grid';
        wrap.style.gridTemplateColumns = 'repeat(10, 1fr)';
        wrap.style.gap = '6px';
        const today = todayISO();
        const days = 30;
        let best=0, sum=0;

        for(let i=days-1;i>=0;i--){
          const dISO = dateAdd(today, -i);
          ensureDay(dISO);
          const pct = Math.round(((state.days[dISO].done.size || 0) / (state.habits.length || 1)) * 100);
          best = Math.max(best, pct); sum += pct;

          const cell = document.createElement('div');
          cell.className='tap';
          cell.title = dISO + ' — ' + pct + '%';
          cell.style.border = '1px solid var(--ring)';
          cell.style.borderRadius = '10px';
          cell.style.background = `linear-gradient(180deg, rgba(97,255,168,${pct/100}), rgba(109,211,255,${pct/100}))`;
          cell.style.minHeight='36px';
          cell.textContent = new Date(dISO).toLocaleDateString(undefined, { month:'numeric', day:'numeric' });
          wrap.appendChild(cell);
        }
        el.appendChild(wrap);

        $('#bestDay').textContent = best + '%';
        $('#avgDay').textContent = Math.round(sum/30) + '%';
      }

      // Trend chart (vanilla canvas)
      function drawTrend(){
        const canvas = $('#trendChart');
        const ctx = canvas.getContext('2d');
        const W = canvas.clientWidth, H = canvas.clientHeight;
        canvas.width = W * devicePixelRatio; canvas.height = H * devicePixelRatio;
        ctx.scale(devicePixelRatio, devicePixelRatio);
        ctx.clearRect(0,0,W,H);

        const today = todayISO();
        const pts = [];
        for(let i=29;i>=0;i--){
          const dISO = dateAdd(today, -i);
          ensureDay(dISO);
          const pct = Math.round(((state.days[dISO].done.size || 0) / (state.habits.length || 1)) * 100);
          pts.push(pct);
        }

        // axes
        ctx.globalAlpha = .5;
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ring');
        ctx.lineWidth = 1;
        [0,25,50,75,100].forEach((p)=>{
          const y = H - (p/100)*H;
          ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
          ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted');
          ctx.font = '10px system-ui, -apple-system, Roboto';
          ctx.fillText(p+'%', 4, y-4);
        });

        // line
        ctx.globalAlpha = 1;
        ctx.lineWidth = 2.5;
        ctx.strokeStyle = '#6dd3ff';
        const step = W / (pts.length-1 || 1);
        ctx.beginPath();
        pts.forEach((v,i)=>{
          const x = i*step;
          const y = H - (v/100)*H;
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();

        // fill
        const grad = ctx.createLinearGradient(0,0,0,H);
        grad.addColorStop(0,'rgba(109,211,255,.35)');
        grad.addColorStop(1,'rgba(97,255,168,.08)');
        ctx.fillStyle = grad;
        ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath(); ctx.fill();

        renderHistory();
      }

      // Export/Import
      function exportJSON(){
        // prepare clean export (Sets -> arrays)
        const snapshot = structuredClone(state);
        const cleanDays = {};
        Object.keys(snapshot.days).forEach(k=>{
          cleanDays[k] = { done: Array.from(snapshot.days[k].done || []) };
        });
        snapshot.days = cleanDays;

        const blob = new Blob([JSON.stringify(snapshot,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'ag-tracker-backup.json'; a.click();
        URL.revokeObjectURL(url);
      }

      $('#exportBtn').addEventListener('click', exportJSON);
      $('#shareBtn').addEventListener('click', exportJSON);
      $('#importFile').addEventListener('change', async (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        const text = await file.text();
        try{
          const obj = JSON.parse(text);
          // revive sets
          if(obj.days){
            Object.keys(obj.days).forEach(k=>{
              obj.days[k].done = new Set(obj.days[k].done || []);
            });
          }
          state = obj; save();
          alert('Import successful.');
        }catch(err){
          alert('Import failed: ' + err.message);
        }
      });
      $('#wipeBtn').addEventListener('click', ()=>{
        if(confirm('Erase ALL data? This cannot be undone.')){
          localStorage.removeItem(stateKey);
          state = defaultState();
          save();
        }
      });

      // Initial render
      function render(){
        renderHabits();
        updateProgressBar();
        renderStreak();
        if(!views.progress.hidden){ drawTrend(); }
      }
      render();

      // accessibility: close dialog on backdrop click
      const dlg = $('#habitDialog');
      dlg?.addEventListener('click', (e)=>{
        const rect = dlg.firstElementChild.getBoundingClientRect();
        const inDialog = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
        if(!inDialog) dlg.close('cancel');
      });

  

      // Resize chart on orientation change
      addEventListener('resize', ()=>{ if(!views.progress.hidden) drawTrend(); });
    })();
  </script>
  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js', { scope: './' })
        .catch(err => console.warn('SW registration failed', err));
    });
  }
</script>

</body>
</html>
